# Contributor: Olivier Mehani <olivier.mehani@nicta.com.au>
#<!GIT
pkgname=oml2-apps
_redmineid=792
#!GIT>
#<GIT
pkgname=oml2-apps-git
#GIT>
pkgver=2.9.0
pkgrel=1
pkgdesc="OML2 applications collection"
arch=(i686 x86_64)
url="http://omlapp.mytestbed.net/"
license=('custom:MIT-Nicta')
depends=('oml2')
optdepends=('gpsd: for gpslogger'
'libsigar: for nmetrics'
'libtrace: for trace'
'wpa_supplicant: for wpamon')
makedepends=('git')
source=(
#<!GIT
	http://oml.mytestbed.net/attachments/download/${_redmineid}/oml2-apps-${pkgver}.tar.gz
#!GIT>
)

#<!GIT
_builddir=${pkgname}-${pkgver}
#!GIT>
#<GIT
_gitroot="git://mytestbed.net/oml-apps.git"
_gitname="oml"
_gitbranch="staging"
_builddir=${_gitname}-build
#GIT>

build() {
	cd "${srcdir}"
#<GIT
	msg "Connecting to GIT server...."
	if [ -d ${_gitname} ] ; then
		cd ${_gitname} && git pull origin
		msg "The local files are updated."
	else
		git clone ${_gitroot} ${_gitname}
	fi
	if [ ! -z ${_gitbranch} ]; then
		cd ${_gitname} && git checkout ${_gitbranch}
		cd ${_gitname} && git checkout master
	fi

	msg "GIT checkout done or server timeout"
	msg "Starting make..."

	rm -rf "${srcdir}/${_builddir}"
	git clone "${srcdir}/${_gitname}" "${srcdir}/${_builddir}"
	cd "${srcdir}/${_builddir}"
#GIT>
	cd "${srcdir}/${_builddir}"
#<GIT
	./autogen.sh
#GIT>
	./configure --prefix=/usr
	make || return 1
}

package() {
	cd "${srcdir}/${_builddir}"
	make DESTDIR="${pkgdir}/" install
}
